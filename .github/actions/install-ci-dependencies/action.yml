name: "Install CI Dependencies"
description: "Install Python dependencies for CI workflows using uv"

inputs:
  python_version:
    description: "Python version to use"
    required: false
    default: "3.13"
  use_oldest:
    description: "Whether to use oldest compatible versions (for testing min version support)"
    required: false
    default: "false"
  use_commit_pin:
    description: "Whether to use Lightning commit pinning via UV_OVERRIDE"
    required: false
    default: "true"
  show_pip_list:
    description: "Whether to show package list output after installations"
    required: false
    default: "false"
runs:
  using: "composite"
  steps:
    - name: Install uv and set Python version
      uses: astral-sh/setup-uv@v7
      with:
        python-version: ${{ inputs.python_version }}
        activate-environment: true
        enable-cache: true
        # Use cache-suffix to differentiate caches by Python version and resolution type
        # This prevents cache conflicts between oldest/latest and different Python versions
        cache-suffix: ${{ inputs.python_version }}-${{ inputs.use_oldest == 'true' && 'oldest' || 'latest' }}
        # Prune cache before saving to limit disk usage (default is true, but be explicit)
        prune-cache: true

    # Install torch separately when nightly is configured
    # - requirements.txt excludes torch (dependencies resolved against nightly)
    # - Skip on macOS ARM64 - nightly +cpu wheels aren't available, use stable torch
    # - Skip for "oldest" builds - they use stable torch from lock file
    - name: Install torch prerelease (if configured)
      if: inputs.use_oldest != 'true'
      shell: bash
      run: |
        PRE_FILE="requirements/ci/torch-pre.txt"
        if [[ -f "${PRE_FILE}" ]]; then
          # Read 3-line config: version, CUDA target, channel type
          # Use while loop for bash 3.2 compatibility (macOS)
          PRE_CONFIG=()
          while IFS= read -r line; do
            PRE_CONFIG+=("$line")
          done < <(grep -v '^#' "${PRE_FILE}" | grep -v '^$')
          TORCH_VERSION="${PRE_CONFIG[0]}"
          CUDA_TARGET="${PRE_CONFIG[1]}"
          CHANNEL_TYPE="${PRE_CONFIG[2]}"

          if [[ -n "${TORCH_VERSION}" && -n "${CHANNEL_TYPE}" ]]; then
            if [[ "${{ runner.os }}" == "macOS" ]]; then
              echo "Skipping torch ${CHANNEL_TYPE} on macOS ARM64 (no +cpu wheels available)"
              echo "Will install stable torch with --torch-backend=auto"
            else
              echo "Installing torch ${CHANNEL_TYPE}: ${TORCH_VERSION}+cpu"
              uv pip install --prerelease=allow "torch==${TORCH_VERSION}+cpu" \
                --index-url "https://download.pytorch.org/whl/${CHANNEL_TYPE}/cpu"
            fi
          fi
        fi

    # Install FTS and all dependencies
    # - UV_OVERRIDE: applies Lightning commit pin from overrides.txt
    # - When prerelease configured (and not macOS): torch already installed, just install rest
    # - For macOS: use --torch-backend=auto for MPS-compatible stable torch
    # - For stable builds: use --torch-backend=cpu
    - name: Install FTS and all dependencies
      shell: bash
      env:
        UV_OVERRIDE: ${{ inputs.use_commit_pin == 'true' && format('{0}/requirements/ci/overrides.txt', github.workspace) || '' }}
      run: |
        if [[ "${{ inputs.use_oldest }}" == "true" ]]; then
          REQ_FILE="requirements/ci/requirements-oldest.txt"
          echo "Installing with oldest versions..."
        else
          REQ_FILE="requirements/ci/requirements.txt"
          echo "Installing with latest versions..."
        fi

        # Check if torch prerelease is configured
        PRE_FILE="requirements/ci/torch-pre.txt"
        TORCH_PRERELEASE="false"
        if [[ -f "${PRE_FILE}" ]]; then
          # Use while loop for bash 3.2 compatibility (macOS)
          PRE_CONFIG=()
          while IFS= read -r line; do
            PRE_CONFIG+=("$line")
          done < <(grep -v '^#' "${PRE_FILE}" | grep -v '^$')
          TORCH_VERSION="${PRE_CONFIG[0]}"
          if [[ -n "${TORCH_VERSION}" ]]; then
            TORCH_PRERELEASE="true"
          fi
        fi

        # Determine install command based on platform and torch configuration
        # - Oldest builds: use --torch-backend=cpu for stable torch
        # - macOS: use --torch-backend=auto (MPS), prerelease not available
        # - Linux/Windows with prerelease: torch already installed, no backend flag needed
        # - Linux/Windows with stable: use --torch-backend=cpu
        if [[ "${{ inputs.use_oldest }}" == "true" ]]; then
          INSTALL_CMD="uv pip install -e . -r ${REQ_FILE} --torch-backend=cpu"
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          INSTALL_CMD="uv pip install -e . -r ${REQ_FILE} --torch-backend=auto"
        elif [[ "${TORCH_PRERELEASE}" == "true" ]]; then
          # Torch prerelease already installed, just install FTS and deps
          INSTALL_CMD="uv pip install -e . -r ${REQ_FILE}"
        else
          INSTALL_CMD="uv pip install -e . -r ${REQ_FILE} --torch-backend=cpu"
        fi

        echo "Running: ${INSTALL_CMD}"
        echo "  UV_OVERRIDE=${UV_OVERRIDE:-'(not set)'}"
        ${INSTALL_CMD}

    - name: Show package list
      if: inputs.show_pip_list == 'true'
      shell: bash
      run: |
        uv pip list
